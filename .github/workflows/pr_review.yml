name: PR Code Review

on:
  pull_request_target:
    branches: [ "master" ]

jobs:
  mypy-review:
    name: MyPy Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install mypy types-requests types-setuptools
          mypy --python-version 3.12 --ignore-missing-imports huapir || true # run mypy to generate type dependencies
          python -m mypy --install-types --non-interactive

      - name: Get changed Python files
        id: changed-files
        run: |
          BASE_SHA=$(git merge-base ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          CHANGED_FILES=$(git diff --name-only $BASE_SHA ${{ github.event.pull_request.head.sha }} | grep '\.py$' || echo "")
          VALID_FILES=""
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              VALID_FILES="$VALID_FILES $file"
            fi
          done
          echo "files=${VALID_FILES}" >> $GITHUB_OUTPUT
          echo "Changed Python files: ${VALID_FILES}"

      - name: Run mypy on changed files
        id: run-mypy
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No Python files changed in this PR."
            echo "has_changed_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changed_files=true" >> $GITHUB_OUTPUT
          # å°†è¾“å‡ºä¿å­˜åˆ°æ–‡æœ¬å’ŒJSONä¸¤ç§æ ¼å¼
          mypy --python-version 3.12 --show-column-numbers --show-error-codes --ignore-missing-imports $CHANGED_FILES > mypy_output.txt || true
          mypy --python-version 3.12 --show-column-numbers --show-error-codes --ignore-missing-imports $CHANGED_FILES --output json > mypy_output.json || true
        continue-on-error: true

      - name: Get PR diff information
        id: get-diff
        if: steps.run-mypy.outputs.has_changed_files == 'true'
        run: |
          # è·å–è¢«ä¿®æ”¹çš„æ–‡ä»¶å’Œè¡Œå·
          BASE_SHA=$(git merge-base ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          git diff -U0 $BASE_SHA ${{ github.event.pull_request.head.sha }} > pr_diff.txt

          # è§£ædiffï¼Œæå–ä¿®æ”¹çš„è¡Œ
          python - <<'EOF'
          import re
          import json
          
          changed_lines = {}
          current_file = None
          
          with open('pr_diff.txt', 'r') as f:
              for line in f:
                  # ä»diffå¤´éƒ¨è·å–æ–‡ä»¶å
                  file_match = re.match(r'^\+\+\+ b/(.+)', line)
                  if file_match:
                      current_file = file_match.group(1)
                      changed_lines[current_file] = []
                      continue
                  
                  # è§£æä»£ç å—ä¿®æ”¹ï¼Œæ ¼å¼å¦‚ï¼š@@ -1,5 +1,9 @@
                  hunk_match = re.match(r'^@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@', line)
                  if hunk_match and current_file:
                      start_line = int(hunk_match.group(1))
                      if hunk_match.group(2):
                          count = int(hunk_match.group(2))
                      else:
                          count = 1
                          
                      # å°†è¿™ä¸ªå—ä¸­æ‰€æœ‰å¢åŠ æˆ–ä¿®æ”¹çš„è¡Œæ·»åŠ åˆ°åˆ—è¡¨
                      for i in range(count):
                          changed_lines[current_file].append(start_line + i)
          
          # å°†ç»“æœå†™å…¥æ–‡ä»¶
          with open('changed_lines.json', 'w') as f:
              json.dump(changed_lines, f)
          EOF
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Process mypy results
        id: process-results
        if: steps.run-mypy.outputs.has_changed_files == 'true'
        run: |
          python - <<'EOF'
          #!/usr/bin/env python3
          import json
          import os
          import re
          
          # è¯»å–diffä¿¡æ¯ï¼Œè·å–ä¿®æ”¹çš„è¡Œ
          try:
              with open("changed_lines.json", "r") as f:
                  changed_lines = json.load(f)
          except FileNotFoundError:
              changed_lines = {}
          
          # è¯»å–æ–‡æœ¬è¾“å‡º
          try:
              with open("mypy_output.txt", "r") as f:
                  text_output = f.read()
          except FileNotFoundError:
              text_output = ""
          
          # è¯»å–JSONè¾“å‡º
          mypy_results = []
          try:
              with open("mypy_output.json", "r") as f:
                  content = f.read().strip()
                  if content:
                      for line in content.splitlines():
                          try:
                              mypy_results.append(json.loads(line))
                          except json.JSONDecodeError:
                              continue
          except FileNotFoundError:
              pass
              
          # å¦‚æœJSONè§£æå¤±è´¥ï¼Œå°è¯•ä»æ–‡æœ¬è§£æé”™è¯¯
          if not mypy_results and text_output:
              pattern = r"(.*?):(\d+):(\d+): (\w+): (.*)"
              matches = re.findall(pattern, text_output)
              for match in matches:
                  file_path, line, column, error_type, message = match
                  mypy_results.append({
                      "file": file_path,
                      "line": int(line),
                      "column": int(column),
                      "code": error_type,
                      "message": message
                  })
          
          # è¿‡æ»¤æ‰ä¸åœ¨PRå˜æ›´æ–‡ä»¶ä¸­çš„é”™è¯¯ï¼Œä½¿ç”¨æ ‡å‡†åŒ–è·¯å¾„å’Œç²¾ç¡®åŒ¹é…æ¥é¿å…ä¼ªé˜³æ€§é”™è¯¯
          changed_files = os.environ.get('CHANGED_FILES', '').split()
          if changed_files:
              normalized_changed_files = [os.path.normpath(f) for f in changed_files]
              mypy_results = [error for error in mypy_results if os.path.normpath(error.get('file', '')) in normalized_changed_files]
          
          # åªä¿ç•™diffä¸­çš„é”™è¯¯
          review_comments = []
          diff_errors = [] # å­˜å‚¨åœ¨diffä¸­çš„é”™è¯¯
          
          for error in mypy_results:
              file_path = error.get("file", "unknown")
              line_num = error.get("line", 0)
              col_num = error.get("column", 0)
              message = error.get("message", "æœªçŸ¥é”™è¯¯")
              code = error.get("code", "unknown")
              
              # æ£€æŸ¥è¿™ä¸€è¡Œæ˜¯å¦åœ¨PR diffä¸­è¢«ä¿®æ”¹
              is_changed_line = False
              for changed_file in changed_lines:
                  if file_path.endswith(changed_file) and line_num in changed_lines[changed_file]:
                      is_changed_line = True
                      break
              
              if is_changed_line:
                  # å¦‚æœæ˜¯ä¿®æ”¹çš„è¡Œï¼Œåˆ›å»ºè¡Œçº§è¯„è®º
                  review_comments.append({
                      "path": file_path,
                      "line": line_num,
                      "body": f"**MyPy ç±»å‹é”™è¯¯**: {message} ({code})\n\nè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ [mypy æ–‡æ¡£](https://mypy.readthedocs.io/en/stable/error_code_list.html#{code.lower() if code != 'unknown' else 'error-codes'})ã€‚"
                  })
                  diff_errors.append(error)
          
          # åˆ›å»ºæ‘˜è¦ä¿¡æ¯
          if diff_errors:
              status = "fail"
              message = f"åœ¨ PR ä¿®æ”¹çš„ä»£ç è¡Œä¸­å‘ç°äº† {len(diff_errors)} ä¸ªç±»å‹é—®é¢˜ï¼Œéœ€è¦ä¿®å¤ã€‚"
          else:
              status = "pass"
              message = f"PR ä¿®æ”¹çš„ä»£ç è¡Œé€šè¿‡äº†ç±»å‹æ£€æŸ¥ã€‚"
          
          summary = {
              "status": status,
              "diff_error_count": len(diff_errors),
              "review_comment_count": len(review_comments),
              "message": message
          }
          
          # å°†è¯„è®ºæ•°æ®ä¿å­˜ä¸ºJSONæ–‡ä»¶
          with open("mypy_review_comments.json", "w") as f:
              json.dump(review_comments, f)
              
          # å°†æ‘˜è¦ä¿å­˜ä¸ºJSONæ–‡ä»¶
          with open("mypy_summary.json", "w") as f:
              json.dump(summary, f)
              
          # å†™å…¥è¾“å‡º
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"result={status}\n")
              f.write(f"diff_error_count={len(diff_errors)}\n")
              f.write(f"review_comment_count={len(review_comments)}\n")
          EOF
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}

      - name: Post line-level PR review comments
        if: steps.process-results.outputs.diff_error_count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            
            // è¯»å–è¯„è®ºæ•°æ®
            const reviewComments = JSON.parse(fs.readFileSync('mypy_review_comments.json', 'utf8'));
            const summary = JSON.parse(fs.readFileSync('mypy_summary.json', 'utf8'));
            
            // åˆ›å»ºPRå®¡æŸ¥
            const review = await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: `## MyPy ç±»å‹æ£€æŸ¥ç»“æœ âŒ\n\n${summary.message}\n\nå·²å¯¹ä¿®æ”¹çš„ä»£ç è¡Œåˆ›å»ºäº† ${reviewComments.length} ä¸ªè¡Œçº§è¯„è®ºã€‚`,
              event: 'COMMENT',
              comments: reviewComments
            });
            
            // æ·»åŠ å¤±è´¥æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['ğŸ”´ ç±»å‹æ£€æŸ¥ï¼šå¤±è´¥']
            });
            
            console.log(`Created review with ${reviewComments.length} comments`);

      - name: Post success comment
        if: steps.process-results.outputs.result == 'pass'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('mypy_summary.json', 'utf8'));
            
            // æŸ¥æ‰¾ä¹‹å‰çš„è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => {
              return c.user.type === 'Bot' && 
                     (c.body.includes('MyPy ç±»å‹æ£€æŸ¥é€šè¿‡') || c.body.includes('MyPy ç±»å‹æ£€æŸ¥ç»“æœ'));
            });
            
            const comment = `## MyPy ç±»å‹æ£€æŸ¥é€šè¿‡ âœ…\n\n${summary.message}`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
            
            // ç§»é™¤å¤±è´¥æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å¹¶æ·»åŠ æˆåŠŸæ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'ğŸ”´ ç±»å‹æ£€æŸ¥ï¼šå¤±è´¥'
              });
            } catch (error) {
              // æ ‡ç­¾å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
            }
            
            // æ·»åŠ æˆåŠŸæ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['âœ… ç±»å‹æ£€æŸ¥ï¼šé€šè¿‡']
            });

      - name: Post notification if no Python files changed
        if: steps.run-mypy.outputs.has_changed_files == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && 
                     (comment.body.includes('MyPy ç±»å‹æ£€æŸ¥é€šè¿‡') || comment.body.includes('MyPy ç±»å‹æ£€æŸ¥ç»“æœ'));
            });
            
            const comment = "## MyPy ç±»å‹æ£€æŸ¥\n\nPR ä¸­æ²¡æœ‰ä¿®æ”¹ä»»ä½• Python æ–‡ä»¶ï¼Œè·³è¿‡ç±»å‹æ£€æŸ¥ã€‚";
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
            
            // ç§»é™¤ç±»å‹æ£€æŸ¥ç›¸å…³æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'ğŸ”´ ç±»å‹æ£€æŸ¥ï¼šå¤±è´¥'
              });
            } catch (error) {
              // æ ‡ç­¾å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
            }
            
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'âœ… ç±»å‹æ£€æŸ¥ï¼šé€šè¿‡'
              });
            } catch (error) {
              // æ ‡ç­¾å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
            }

      - name: Fail if type issues found in diff
        if: steps.process-results.outputs.diff_error_count != '0'
        run: exit 1
